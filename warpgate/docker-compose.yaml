---
networks:
  traefik_proxy:
    external: true
    name: traefik_traefik_proxy

volumes:
  warpgate_data:
    driver: local
    driver_opts:
      type: nfs4
      o: addr=172.24.32.5,rw
      device: ":/srv/nfs4/docker_nfs/warpgate/"

services:
  warpgate:
    image: ghcr.io/warp-tech/warpgate:0.20.2
    container_name: warpgate
    hostname: homeauto
    restart: unless-stopped
    networks:
      - traefik_proxy
    ports:
      - "2222:2222"   # SSH
      - "9999:9999"   # HTTP (for testing; Traefik handles external access)
    volumes:
      - warpgate_data:/data
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_traefik_proxy
      - traefik.http.routers.warpgate-http.entrypoints=web
      - traefik.http.routers.warpgate-http.rule=Host(`warpgate.viewpoint.house`)
      - traefik.http.routers.warpgate-http.middlewares=warpgate-https
      - traefik.http.middlewares.warpgate-https.redirectscheme.scheme=https
      - traefik.http.routers.warpgate.rule=Host(`warpgate.viewpoint.house`)
      - traefik.http.routers.warpgate.entrypoints=websecure
      - traefik.http.routers.warpgate.tls=true
      - traefik.http.services.warpgate.loadbalancer.server.port=9999
      # - traefik.http.services.warpgate.loadbalancer.healthcheck.path=/
      # - traefik.http.services.warpgate.loadbalancer.healthcheck.port=9999
      - homepage.group=Infrastructure
      - homepage.name=Warpgate
      - homepage.href=https://warpgate.viewpoint.house
      - homepage.description=SSH/HTTP Bastion
      - homepage.icon=mdi-shield-lock
      - com.centurylinklabs.watchtower.enable=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
